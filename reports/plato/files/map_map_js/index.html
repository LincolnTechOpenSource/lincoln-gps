<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - map/map.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>map/map.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">67.45</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">295</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.32</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.95</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * map.js
 * Matthew Vasseur
 * 06/02/16
 **/
(function() {
    &#039;use strict&#039;;

    // array of department class names
    var DEPARTMENT_NAMES = [
        &#039;account_setup&#039;, &#039;accounting&#039;, &#039;acd&#039;, &#039;asset_mgmt&#039;, &#039;branch_dev&#039;, &#039;branch_serv&#039;,
        &#039;broom&#039;, &#039;busi_dev&#039;, &#039;compli_licens&#039;, &#039;conf&#039;, &#039;copy_scan_rm&#039;, &#039;doc_mgmt&#039;, &#039;elevator_exit&#039;,
        &#039;euc&#039;, &#039;exec_suite&#039;, &#039;facilities&#039;, &#039;finance&#039;, &#039;food&#039;, &#039;hr&#039;, &#039;isd&#039;, &#039;im_r&#039;, &#039;isa&#039;,
        &#039;mrkt_comm&#039;, &#039;one_time_financials&#039;, &#039;ops&#039;, &#039;prvd_mgmt&#039;, &#039;quality_cntrl&#039;,
        &#039;reception&#039;, &#039;rdi&#039;, &#039;retire_serv&#039;, &#039;stairs_exit&#039;, &#039;tpa&#039;, &#039;vsa&#039;
    ];

    angular
        .module(&#039;app.map&#039;)
        .constant(&#039;DEPARTMENT_NAMES&#039;, DEPARTMENT_NAMES)
        .controller(&#039;MapCtrl&#039;, MapCtrl);

    MapCtrl.$inject = [&#039;$rootScope&#039;, &#039;$scope&#039;, &#039;$log&#039;, &#039;$q&#039;, &#039;Users&#039;, &#039;Locations&#039;,
        &#039;Firebase&#039;, &#039;DEPARTMENT_NAMES&#039;, &#039;Graphing&#039;, &#039;Params&#039;, &#039;Dijkstra&#039;
    ];
    // jshint maxparams:12
    function MapCtrl($rootScope, $scope, $log, $q, Users, Locations,
        Firebase, DEPARTMENT_NAMES, Graphing, Params, Dijkstra) {
        var vm = this;

        vm.selectNode = {
            nodes: null, // only load if user is authenticated
            fromNode: null, // this will also serve as the parameter employee
            toNode: null,
            FIND_ON_MAP: &#039;FIND_ON_MAP&#039;
        };
        // vm.clear = clear;
        vm.clearLocation = clearLocation;

        $scope.$watch(&#039;vm.selectNode.toNode&#039;, watchNode.bind(null, &#039;toNode&#039;));
        $scope.$watch(&#039;vm.selectNode.fromNode&#039;, watchNode.bind(null, &#039;fromNode&#039;));

        // load employees when signed in
        Firebase.auth().$onAuthStateChanged(userAuth);

        // ready document specific commands
        $(document).ready(documentReady);

        // activate the controller on view enter
        $scope.$on(&#039;$ionicView.enter&#039;, activate);

        // initialize &amp; create graph
        Graphing.debug = true; // debug for testing purposes
        Graphing.createGraph();

        //------------------------------------------------//

        /** run upon controller activate */
        function activate() {
            // handle employee parameter
            if (!!Params.employee) {
                $(&#039;#svg #map g.non-walls .path&#039;).removeClass(&#039;hilite&#039;); // clear
                // set current employee and from node given parameter
                vm.selectNode.fromNode = Params.employee;
                vm.selectNode.toNode = null; // null out &#039;to&#039;
                Params.employee = null; // null out parameter after &#039;use&#039;
            }

            // filter the map as prescribed
            Users.load().then(usersLoad);

            // $log.info(&#039;Activated Map View&#039;);
            return true;
        }

        /** functions for after users have loaded */
        function usersLoad() {
            var user = $rootScope.user || Users.get(Firebase.auth().$getAuth().uid);
            $(&#039;#svg #map .loc&#039;).removeClass(&#039;filter-out&#039;); // remove old filter
            for (var filter in user.filters) {
                if (user.filters.hasOwnProperty(filter)) {
                    if (!user.filters[filter].disp) {
                        $(&#039;#svg #map .loc.&#039; + filter).addClass(&#039;filter-out&#039;);
                    }
                }
            }
        }

        /** handle user authentication */
        function userAuth(user) {
            if (user) {
                load();
            }
            else {
                Locations.unload();
                vm.selectNode.nodes = null;
            }
        }

        /** load the Locations table */
        function load() {
            if (Locations.loaded()) {
                vm.selectNode.nodes = Locations.all();
                return true;
            }
            else {
                var promises = [all()];
                return Locations.load(promises).then();
            }
        }

        function all() {
            return $q.when(Locations.all()).then(function() {
                vm.selectNode.nodes = Locations.all();
                $log.info(&#039;Locations Loaded&#039;);
                return vm.selectNode.nodes;
            });
        }

        // /** resets the path and removes all highlights (but leaves employee) */
        // function clear() {
        //     $(&#039;#svg #map g.non-walls *&#039;).removeClass(&#039;hilite&#039;); // clear old path

        //     // clear graphing parameters
        //     vm.selectNode.toNode = null;
        //     vm.selectNode.fromNode = null;
        // }

        /** resets the selected location and removes path highlighting
         * @locSelect will be either &#039;fromNode&#039; or &#039;toNode&#039; (e.g., a field of selectNode)
         */
        function clearLocation(locSelect) {
            // remove highlighting from path
            $(&#039;#svg #map g.non-walls .path&#039;).removeClass(&#039;hilite&#039;);
            if (vm.selectNode[locSelect] !== vm.selectNode.toNode ||
                vm.selectNode[locSelect] !== vm.selectNode.fromNode) {
                $(&#039;#svg #map #&#039; + vm.selectNode[locSelect].id).removeClass(&#039;hilite&#039;);
            }
            vm.selectNode[locSelect] = null; // clear the location
        }

        /** watch a @node (to or from) for changes and handle them (via mapping) */
        function watchNode(node, newNode, oldNode) {
            // select on map option
            if (newNode === vm.selectNode.FIND_ON_MAP) {
                vm.selectNode[node] = null; // clear value
                $(&#039;#svg #map #outer-border&#039;).addClass(&#039;select-me&#039;);
                $(&#039;#svg #map&#039;).attr(&#039;select-on-click&#039;, node);
            }
            // find directions
            else {
                findDirections();
                // also change highlight from old node to new node
                if (!!newNode) {
                    $(&#039;#svg #map #&#039; + newNode.id).addClass(&#039;hilite&#039;);
                }
            }
            if (!!oldNode &amp;&amp; (vm.selectNode[node] !== oldNode) &amp;&amp; (newNode !== oldNode)) {
                $(&#039;#svg #map #&#039; + oldNode.id).removeClass(&#039;hilite&#039;);
            }
        }

        function findDirections() {

            if (!!vm.selectNode.fromNode &amp;&amp; !!vm.selectNode.toNode) {
                var dirResults = Dijkstra.run(vm.selectNode.fromNode.$id,
                    vm.selectNode.toNode.$id, Graphing.graph);

                var directions = Dijkstra.getPath(dirResults.prev, vm.selectNode.toNode.$id);

                $(&#039;#svg #map .loc&#039;).removeClass(&#039;hilite&#039;); // clear old path

                (function($) {
                    $.fn.queued = function() {
                        var self = this;
                        var func = arguments[0];
                        var args = [].slice.call(arguments, 1);
                        return this.queue(function() {
                            $.fn[func].apply(self, args).dequeue();
                        });
                    };
                }($));

                // hilite each block in the path
                for (var i = 0; i &lt; directions.length; i++) {
                    $(&#039;#svg #map .loc#&#039; + directions[i]).delay(100 * i).queued(&#039;addClass&#039;, &#039;hilite&#039;);
                }
            }

                            //TODO: Create function that resizes/positions map according to path weight that was calculated via Djikstra
                //function resizeMap(event){
                /*      if (node._weight &gt; 50) {
                          mapPanZoom.fit();
                          mapPanZoom.resize();
                          mapPanZoom.center();
                          mapPanZoom.resetZoom();
                      } */
                //}
        }

        function checkSelect(event) {
            var id = event.target.id || $(event.target).parent(&#039;g&#039;)[0].id;
            var selectOnClick = $(&#039;#svg #map&#039;).attr(&#039;select-on-click&#039;);

            if (selectOnClick !== &#039;false&#039;) {
                $q.when(Locations.get(id)).then(function(loc) {
                    vm.selectNode[selectOnClick] = loc;
                });

                $(&#039;#svg #map #outer-border&#039;).removeClass(&#039;select-me&#039;);
                $(&#039;#svg #map&#039;).attr(&#039;select-on-click&#039;, &#039;false&#039;);
            }
        }

        function documentReady() {
            $(&#039;#svg&#039;).on(&#039;click&#039;, &#039;#map .loc:not(.path)&#039;, checkSelect);

            for (var i = 0; i &lt; DEPARTMENT_NAMES.length; i++) {
                $(&#039;.dep_list .&#039; + DEPARTMENT_NAMES[i]).hover(
                    // attach hover element to each legend component so that hovering over text
                    // makes all corresponding locations highlight
                    batchToggleClass([&#039;.loc.&#039; + DEPARTMENT_NAMES[i] + &#039;:not(.filter-out), &#039; +
                        &#039;.dep_list .&#039; + DEPARTMENT_NAMES[i] + &#039; .dep_list_colorbox&#039;,
                        &#039;.dep_list .&#039; + DEPARTMENT_NAMES[i] + &#039; .dep_list_text&#039;
                    ], [&#039;hilite&#039;, &#039;normal-text&#039;]));

                // attach hover element to each loc component so that hovering over location
                // makes the corresponding legend item highlight
                $(&#039;.loc:not(.filter-out).&#039; + DEPARTMENT_NAMES[i]).hover(
                    batchToggleClass([&#039;.dep_list .&#039; + DEPARTMENT_NAMES[i] + &#039; .dep_list_colorbox&#039;,
                        &#039;.dep_list .&#039; + DEPARTMENT_NAMES[i] + &#039; .dep_list_text&#039;
                    ], [&#039;hilite&#039;, &#039;normal-text&#039;]));
            }

            $(&#039;#map&#039;).height($(&#039;#svg&#039;).height() * 0.9);

            var beforePan = function(oldPan, newPan) {
                var gutterWidth = 75;
                var gutterHeight = 75;
                // Computed variables
                var sizes = this.getSizes();
                var leftLimit = -((sizes.viewBox.x + sizes.viewBox.width) * sizes.realZoom) + gutterWidth;
                var rightLimit = sizes.width - gutterWidth - (sizes.viewBox.x * sizes.realZoom);
                var topLimit = -((sizes.viewBox.y + sizes.viewBox.height) * sizes.realZoom) + gutterHeight;
                var bottomLimit = sizes.height - gutterHeight - (sizes.viewBox.y * sizes.realZoom);

                return {
                    x: Math.max(leftLimit, Math.min(rightLimit, newPan.x)),
                    y: Math.max(topLimit, Math.min(bottomLimit, newPan.y))
                };
            };

            // Expose to window namespace for testing purposes
            /* global svgPanZoom */
            var mapPanZoom = svgPanZoom(&#039;#map&#039;, {
                viewportSelector: &#039;#map&#039;,
                useCurrentView: true,
                zoomEnabled: true,
                controlIconsEnabled: false,
                preventMouseEventsDefault: false,
                fit: true,
                center: true,
                beforePan: beforePan
            });

            $(&#039;#zoom-in&#039;).on(&#039;click&#039;, function(ev) {
                ev.preventDefault();

                mapPanZoom.zoomIn();
            });

            $(&#039;#zoom-out&#039;).on(&#039;click&#039;, function(ev) {
                ev.preventDefault();

                mapPanZoom.zoomOut();
            });

            $(&#039;#reset&#039;).on(&#039;click&#039;, function(ev) {
                ev.preventDefault();

                mapPanZoom.fit();
                mapPanZoom.resize();
                mapPanZoom.center();
                mapPanZoom.resetZoom();
            });
        }

    }

    /** batchToggleClass: toggles the @classes of the specified @selectors
     * toggles the corresponding class of an array of selectors */
    function batchToggleClass(selectors, classes) {
        return function() {
            console.assert(selectors.length === classes.length, &#039;Invalid Call to batchToggleClass&#039;);
            for (var i = 0; i &lt; selectors.length; i++) {
                $(selectors[i]).toggleClass(classes[i]);
            }
        };
    }
})();

// debugging to get neighbors
// $(&#039;#svg&#039;).on(&#039;click&#039;, &#039;#map .loc&#039;, function() { console.log(this.id); });

// debugging to highlight neighbors
// $(&#039;#svg&#039;).on(&#039;click&#039;, &#039;#map .loc&#039;, function() {
//     var n = Graphing.graph.nodes[this.id];
//     $(&#039;#svg #map .loc&#039;).removeClass(&#039;hilite&#039;); // clear old path
//     for (var i = 0; i &lt; n._neighbors.length; i++) {
//         $(&#039;#&#039; + n._neighbors[i]).addClass(&#039;hilite&#039;);
//     }
// });</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
